class Client{ignoreNext=!0;constructor({prefix:e="!",self_commands:t=!0,queue:s=!1,queue_max_length:a=5,fetchInterval:i=100,autosaveInterval:n=1e4}={prefix:"!",self_commands:!0,queue:!1,queue_max_length:5,fetchInterval:100,autosaveInterval:1e4}){this.commands=new Map,this.events={},this.handledMessages=null===localStorage.getItem("handledMessages")?new Array:Array.from(JSON.parse(localStorage.getItem("handledMessages"))),this.messageFetcher=setInterval(()=>{if(null!==getChat()){const i=s?[].slice.call(getChat().children,-a):[getChat().lastChild];for(const s of i)if(s.hasAttribute("data-id")&&!this.handledMessages.includes(s.getAttribute("data-id"))){this.handledMessages.push(s.getAttribute("data-id"));const a=this.getMessageFromElement(s);if(void 0!==a)if(this.ignoreNext)this.ignoreNext=!1;else{if(t||s.getAttribute("data-id").startsWith("false_"))for(const[t,s]of this.commands.entries())if(a.content.message.startsWith(e+t))return s(a,a.content.message.substring(e.length+t.length).split(" ").splice(1)),void this.emit("command",[t,s]);this.emit("message",a),this.emit("message_"+(s.getAttribute("data-id").startsWith("true_")?"self":"other"),a)}}}},i),this.autoSaver=setInterval(()=>{localStorage.setItem("handledMessages",JSON.stringify(null===localStorage.getItem("handledMessages")?new Array:Array.from(JSON.parse(localStorage.getItem("handledMessages"))).slice(-10*a)))},n),this.emit("init")}registerCommand(e,t){this.commands.set(e,t)}unregisterCommand(e){this.commands.delete(e)}emit(e,...t){for(let s of this.events[e]||[])s(...t)}on(e,t){return(this.events[e]=this.events[e]||[]).push(t),()=>this.events[e]=this.events[e].filter(e=>e!==t)}sendMessage(e){this.ignoreNext=!0;const t=getTextBox().textContent;getTextBox().textContent=e,getTextBox().dispatchEvent(new InputEvent("input",{bubbles:!0})),new Promise(e=>{null!==getSendButton()&&(getSendButton().click(),getTextBox().textContent=t,getTextBox().dispatchEvent(new InputEvent("input",{bubbles:!0})),e())})}gotoNewestChat(){for(const e of getChats().children)"translateY(0px)"===e.style.transform&&e.firstChild.firstChild.lastChild.firstChild.firstChild.firstChild.firstChild.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0}))}getMessageFromElement(e){if(null===e.querySelector("[data-pre-plain-text]"))return;const t=e.querySelector("[data-pre-plain-text]").getAttribute("data-pre-plain-text").match(/\] (.*):/)[1],s=e.querySelector("[data-pre-plain-text]").lastChild.children[getChat().lastChild.querySelector("[data-pre-plain-text]").lastChild.childElementCount-2].innerText,a=null===e.querySelector("[data-pre-plain-text]").firstChild.firstChild.firstChild.lastChild.firstChild?null:e.querySelector("[data-pre-plain-text]").firstChild.firstChild.firstChild.lastChild.firstChild.lastChild.innerText,i=Array.from(e.querySelector("[data-pre-plain-text]").querySelectorAll("[src^=data]")),n=e.querySelector("[data-pre-plain-text]").getAttribute("data-pre-plain-text").match(/\[(.*)\]/)[1];return new Message(t,new MessageContent(s,a,i),n)}stop(){clearInterval(this.messageFetcher),clearInterval(this.autoSaver)}}const getTextBox=()=>document.querySelector("#main > footer > div._3SvgF._1mHgA.copyable-area > div.DuUXI > div > div._1awRl.copyable-text.selectable-text"),getSendButton=()=>document.querySelector("#main > footer > div._3SvgF._1mHgA.copyable-area > div:nth-child(3) > button"),getChat=()=>document.querySelector("#main > div.RUGMB > div > div > div.tSmQ1"),getChats=()=>document.querySelector("#pane-side > div:nth-child(1) > div > div");class Message{constructor(e,t,s){this.sender=e,this.content=t,this.timestamp=s}}class MessageContent{constructor(e,t,s){this.message=e,this.reaction=t,this.images=s}}