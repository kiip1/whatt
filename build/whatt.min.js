class Client{constructor({prefix:e="!",self_commands:t=!0,queue:a=!1,queue_max_length:s=5,fetchInterval:i=100,autosaveInterval:n=1e4}={prefix:"!",self_commands:!0,queue:!1,queue_max_length:5,fetchInterval:100,autosaveInterval:1e4}){this.commands=new Map,this.events={},this.handledMessages=null===localStorage.getItem("handledMessages")?new Array:Array.from(JSON.parse(localStorage.getItem("handledMessages"))),this.messageFetcher=setInterval(()=>{if(null!==getChat()){const i=a?[].slice.call(getChat().children,-s):[getChat().lastChild];for(const a of i)if(a.hasAttribute("data-id")&&!this.handledMessages.includes(a.getAttribute("data-id"))){this.handledMessages.push(a.getAttribute("data-id"));const s=this.getMessageFromElement(a);if(void 0!==s){if(t||a.getAttribute("data-id").startsWith("false_"))for(const[t,a]of this.commands.entries())if(s.content.message.startsWith(e+t))return a(s,s.content.message.substring(e.length+t.length).split(" ").splice(1)),void this.emit("command",[t,a]);this.emit("message",s),this.emit("message_"+(a.getAttribute("data-id").startsWith("true_")?"self":"other"),s)}}}},i),this.autoSaver=setInterval(()=>{localStorage.setItem("handledMessages",JSON.stringify(this.handledMessages))},n),this.emit("init")}registerCommand(e,t){this.commands.set(e,t)}unregisterCommand(e){this.commands.delete(e)}emit(e,...t){for(let a of this.events[e]||[])a(...t)}on(e,t){return(this.events[e]=this.events[e]||[]).push(t),()=>this.events[e]=this.events[e].filter(e=>e!==t)}sendMessage(e){const t=getTextBox().textContent;getTextBox().textContent=e,getTextBox().dispatchEvent(new InputEvent("input",{bubbles:!0})),new Promise(e=>{null!==getSendButton()&&(getSendButton().click(),getTextBox().textContent=t,getTextBox().dispatchEvent(new InputEvent("input",{bubbles:!0})),e())})}gotoNewestChat(){for(const e of getChats().children)if("translateY(0px)"===e.style.transform)return e.firstChild.firstChild.lastChild.firstChild.firstChild.firstChild.firstChild.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0}))}getMessageFromElement(e){if(null!==e.querySelector("[data-pre-plain-text]"))try{const t=e.querySelector("[data-pre-plain-text]").getAttribute("data-pre-plain-text").match(/\] (.*):/)[1],a=e.querySelector("[data-pre-plain-text]").lastChild.children[getChat().lastChild.querySelector("[data-pre-plain-text]").lastChild.childElementCount-2].innerText,s=e.querySelector("[data-pre-plain-text]").firstChild.firstChild.firstChild.lastChild.firstChild.lastChild.innerText,i=Array.from(e.querySelector("[data-pre-plain-text]").querySelectorAll("[src^=data]")),n=e.querySelector("[data-pre-plain-text]").getAttribute("data-pre-plain-text").match(/\[(.*)\]/)[1];return new Message(t,new MessageContent(a,s,i),n)}catch(t){const a=e.querySelector("[data-pre-plain-text]").getAttribute("data-pre-plain-text").match(/\] (.*):/)[1],s=e.querySelector("[data-pre-plain-text]").lastChild.children[getChat().lastChild.querySelector("[data-pre-plain-text]").lastChild.childElementCount-2].innerText,i=Array.from(e.querySelector("[data-pre-plain-text]").querySelectorAll("[src^=data]")),n=e.querySelector("[data-pre-plain-text]").getAttribute("data-pre-plain-text").match(/\[(.*)\]/)[1];return new Message(a,new MessageContent(s,null,i),n)}}stop(){clearInterval(this.messageFetcher),clearInterval(this.autoSaver)}}const getTextBox=()=>document.querySelector("#main > footer > div._3ee1T._1LkpH.copyable-area > div._3uMse > div > div._3FRCZ.copyable-text.selectable-text"),getSendButton=()=>document.querySelector("#main > footer > div._3ee1T._1LkpH.copyable-area > div:nth-child(3) > button"),getChat=()=>document.querySelector("#main > div._3h-WS > div > div > div.z_tTQ"),getChats=()=>document.querySelector("#pane-side > div:nth-child(1) > div > div");class Message{constructor(e,t,a){this.sender=e,this.content=t,this.timestamp=a}}class MessageContent{constructor(e,t,a){this.message=e,this.reaction=t,this.images=a}}